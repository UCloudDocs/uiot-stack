# 消息路由配置详解


消息路由不同消息源与目的地（函数计算、本地应用、子设备、IoT云平台）之间流转可使用的Topic不同。

可以通过配置多条消息路由首尾相接实现级联。级联往往以**子设备、UIoT云平台**为起点或终点，中间经过一次或多次**函数计算**和**本地应用**。



## 消息路由支持的流转类型

消息路由流转可以使用以下两类Topic，Topic支持 `+`、`#` 通配符，通配符的使用方法可以参考Topic通配符：

1. 针对在IoT平台定义的系统Topic、自定义Topic：

| 消息源   | 目的地            | 可使用Topic及权限                                            |
| -------- | ----------------- | ------------------------------------------------------------ |
| IoT平台  | 子设备            | 当前网关子设备的Topic（订阅或订阅&发布）                     |
| IoT平台  | 函数计算          | 当前网关子设备的Topic（订阅或订阅&发布）<br>当前网关设备Topic（订阅或订阅&发布） |
| IoT平台  | 本地应用          | 当前网关子设备的Topic（订阅或订阅&发布）<br/>当前网关设备Topic（订阅或订阅&发布） |
| 子设备   | IoT平台           | 当前网关子设备的Topic（发布或订阅&发布）<br/>当前网关设备Topic（发布或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅&发布） |
| 子设备   | 函数计算          | 当前网关子设备的Topic（发布或订阅&发布）<br/>当前网关设备Topic（发布或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅&发布）<br/>可使用本地Topic |
| 子设备   | 本地应用          | 当前网关子设备的Topic（发布或订阅&发布）<br/>当前网关设备Topic（发布或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅&发布）<br/>可使用本地Topic |
| 函数计算 | IoT平台 | 当前网关子设备的Topic（发布或订阅&发布）<br/>当前网关设备Topic（发布或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅&发布） |
| 函数计算 | 子设备 | 当前网关子设备的Topic（订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（订阅或订阅&发布）<br>可使用本地Topic |
| 函数计算 | 函数计算 | 当前网关子设备的Topic（发布或订阅或订阅&发布）<br/>当前网关设备Topic（发布或订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅或订阅&发布）<br/>可使用本地Topic |
| 函数计算 | 本地应用 | 当前网关子设备的Topic（发布或订阅或订阅&发布）<br/>当前网关设备Topic（发布或订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅或订阅&发布）<br/>可使用本地Topic |
| 本地应用 | 子设备 | 当前网关子设备的Topic（订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（订阅或订阅&发布）<br/>可使用本地Topic |
| 本地应用 | 函数计算 | 当前网关子设备的Topic（发布或订阅或订阅&发布）<br/>当前网关设备Topic（发布或订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅或订阅&发布）<br/>可使用本地Topic |
| 本地应用 | 本地应用 | 当前网关子设备的Topic（发布或订阅或订阅&发布）<br/>当前网关设备Topic（发布或订阅或订阅&发布）<br/>当前网关全部子设备Topic（+）（发布或订阅或订阅&发布）<br/>可使用本地Topic |

注：针对网关本地Topic，本地Topic不能流转到云平台，所以消息源或目的地为**IoT平台**的不能参与流转：

## 二、操作指南

### 创建消息路由

创建消息路由按照交互引导填写内容

![图片](../../images/消息路由-5.png)

**topic类型说明：**

自定义：用户自定义的Topic，可在产品管理中Topic管理创建;
系统：IoT平台系统提供的Topic，仅支持RRPC；
本地：仅在网关本地（函数计算、非IoT平台感知的子设备）流转的Topic



当来源或目的选择为函数计算或本地应用时 需选择使用的函数计算或本地应用。

![图片](../../images/消息路由-6.png)

当目的选择IoT平台时可指定是否缓存。开启离线缓存后，若网关离线，消息将被缓存，待网关上线后发送消息到IoT 平台（QoS质量为1）

注：开启缓存后，网关离线缓存的消息会在网关在线后同新的数据一起上报到IoT平台，建议在消息中增加时间戳便于业务端作为处理消息顺序的依据。

![图片](../../images/消息路由-7.png)

### 禁用启用消息路由

选择需要操作的消息路由进行禁用/启用即可，操作后需重新部署网关方可生效。

![图片](../../images/消息路由-8.png)

